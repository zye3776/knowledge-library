# Markdown Index Generator

Auto-generates hierarchical documentation indexes within CLAUDE.md files using Claude AI for intelligent summaries.

## Features

- **AI-powered summaries**: Each file gets a brief description generated by Claude
- **Hierarchical structure**: Each folder has its own CLAUDE.md with index section
- **Non-destructive updates**: Only updates the `<docs_index>` section, preserving other content
- **Auto-triggered**: Husky pre-commit hook runs only when watched folders change
- **Efficient**: Only regenerates indexes for folders with changed files

## Output Format

The script manages only the `<docs_index>` section within CLAUDE.md. Other content (custom instructions, rules, etc.) is preserved.

```markdown
# CLAUDE.md

<!-- Your custom instructions here are preserved -->

Always use TypeScript for new files.
Follow the project coding standards.

<docs_index>
<!-- AUTO-GENERATED by generate-index.ts. Do not edit this section manually. -->

## Documentation Index: docs/api

<folder_description>API reference documentation for authentication and data endpoints.</folder_description>

### Files

<docs>
<doc path="authentication.md" description="Covers OAuth2 flow, token refresh, and session management for API access." />
<doc path="endpoints.md" description="Reference for all REST endpoints including request/response schemas." />
</docs>

### Subfolders

For detailed documentation in subfolders, read the CLAUDE.md file in each subfolder.

<subfolders>
<subfolder path="examples/" hint="Code examples and usage patterns." />
</subfolders>
</docs_index>
```

## Installation

### Quick Setup

```bash
# Copy files to your project
cp generate-index.ts scripts/
cp pre-commit .husky/

# Install dependencies
bun add -d husky @anthropic-ai/sdk

# Initialize Husky
bunx husky init

# Make hook executable
chmod +x .husky/pre-commit
```

### Or run the setup script

```bash
chmod +x setup.sh
./setup.sh
```

## Configuration

### Watched Folders

Edit `.husky/pre-commit` to change watched folders:

```bash
WATCHED_FOLDERS="docs .cloud/rules"
```

### Environment Variables

Set your Anthropic API key:

```bash
export ANTHROPIC_API_KEY="your-key-here"
```

Or add to your `.env` file (ensure it's loaded before commits).

## Manual Usage

Generate index for a specific folder:

```bash
bun scripts/generate-index.ts docs/
bun scripts/generate-index.ts docs/api/
bun scripts/generate-index.ts .cloud/rules/
```

## How It Works

1. **Pre-commit hook** detects staged `.md` files in watched folders
2. **Identifies affected directories** from the staged files
3. **Runs generate-index.ts** for each affected directory
4. **Claude API** generates summaries for files and folder descriptions
5. **CLAUDE.md updated** â€” only the `<docs_index>` section is replaced
6. **Auto-staged** for the commit

## Preserving Custom Content

Your CLAUDE.md can contain any custom instructions outside the `<docs_index>` tags:

```markdown
# CLAUDE.md

## Project Rules

- Use TypeScript strict mode
- All API responses must be typed

<docs_index>
<!-- This section is auto-managed -->
...
</docs_index>

## Additional Notes

Any content outside the tags is preserved.
```

## Customization

### Change the AI Model

In `generate-index.ts`, modify the model parameter:

```typescript
const message = await client.messages.create({
  model: "claude-sonnet-4-20250514", // Change to your preferred model
  // ...
});
```

### Adjust Summary Length

Modify the prompt and `max_tokens` in `generateSummary()`:

```typescript
max_tokens: 150, // Increase for longer summaries
```

### Change Managed Tag Name

Edit the constants at the top of `generate-index.ts`:

```typescript
const MANAGED_TAG = "docs_index";
```

## Troubleshooting

### Hook not running
- Ensure `.husky/pre-commit` is executable: `chmod +x .husky/pre-commit`
- Check Husky is initialized: `bunx husky init`

### API errors
- Verify `ANTHROPIC_API_KEY` is set
- Check API rate limits

### Index not staged
- The hook auto-stages CLAUDE.md files
- If issues persist, manually run: `git add */CLAUDE.md`
