---
name: pipeline
description: Run the full Extract -> Refine -> Consume pipeline from YouTube URL to audio.
---

# Pipeline

Run the complete content pipeline from a YouTube URL to listenable audio in one session.

**Usage:** `/pipeline {youtube-url} [-v voice]`

## When to Use

- User wants to go from YouTube URL to audio in one step
- Running the full Extract -> Refine -> Consume pipeline
- Fire-and-forget content processing

**Requires:** `yt-dlp`, `OPENAI_API_KEY`, `ffmpeg` (for long content).

## Instructions

<instructions>

### Step 1: Parse Arguments

1. The user provides a YouTube URL as the first argument
2. Optional: `-v {voice}` for TTS voice selection (default: `nova`)
3. If no URL provided, report error:
   ```
   Error: No YouTube URL provided.
   Usage: /pipeline {youtube-url} [-v voice]
   ```

### Step 2: Stage 1 - Extract

1. Log: `[1/3] Extracting transcript...`
2. Invoke the extract-youtube skill:
   ```bash
   .claude/skills/extract-youtube/scripts/extract "{url}"
   ```
3. If extraction fails, report error with stage context and stop:
   ```
   Pipeline failed at Stage 1 (Extract): {error}
   ```
4. Get the video title from the extraction output
5. Invoke the save-content skill to save transcript and metadata:
   ```bash
   .claude/skills/save-content/scripts/save --url "{url}" --title "{title}" --transcript "{transcript}"
   ```
6. Note the slug generated by save-content
7. Log: `[1/3] Extract complete: libraries/{slug}/transcript.md`

### Step 3: Stage 2 - Refine

1. Log: `[2/3] Refining content...`
2. Invoke the refine skill: `/refine {slug}`
   - This runs the unified refinement prompt (sponsors, visual refs, ads)
   - It will present the review menu ([A]pprove / [R]eject / [V]iew / [E]dit)
3. Wait for user's review decision
4. If refinement fails, report error and stop:
   ```
   Pipeline failed at Stage 2 (Refine): {error}
   Completed stages preserved in libraries/{slug}/
   ```
5. Log: `[2/3] Refine complete`

### Step 4: Stage 3 - Consume

1. Log: `[3/3] Generating audio...`
2. Invoke the consume skill: `/consume {slug} -v {voice}`
3. If audio generation fails, report error and stop:
   ```
   Pipeline failed at Stage 3 (Consume): {error}
   Completed stages preserved in libraries/{slug}/
   ```
4. Log: `[3/3] Audio generated: libraries/{slug}/audio.mp3`

### Step 5: Pipeline Summary

Display the completion summary:
```
PIPELINE COMPLETE

  Source: {url}
  Title: {title}
  Location: libraries/{slug}/

  Stages:
    [1] Extract: {word_count} words
    [2] Refine: {refined_word_count} words ({reduction}% reduction)
    [3] Consume: audio.mp3 generated

  Files:
    - transcript.md (original)
    - refined.md (cleaned)
    - audio.mp3 (voice: {voice})
    - metadata.yaml
```

</instructions>

## Error Handling

| Condition | Action |
|-----------|--------|
| No URL provided | Report error with usage |
| Extract fails | Report stage 1 error, stop |
| Save fails | Report stage 1 error, stop |
| Refine fails | Report stage 2 error, preserve stage 1 output |
| Consume fails | Report stage 3 error, preserve stage 1-2 output |
| User rejects refinement | Continue to consume with transcript.md |

## Examples

```bash
# Full pipeline with default voice
/pipeline https://youtube.com/watch?v=abc123

# Full pipeline with specific voice
/pipeline https://youtube.com/watch?v=abc123 -v echo
```
