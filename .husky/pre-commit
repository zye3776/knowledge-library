#!/bin/sh

# Load API key from .env.local if it exists (not committed to git)
[ -f .env.local ] && export $(grep -v '^#' .env.local | xargs)

# Pre-commit hook for auto-generating markdown indexes
# Only runs when markdown files in watched folders change

# Folders to watch for changes
WATCHED_FOLDERS="docs .claude/rules"

# Get list of staged markdown files
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.md$' || true)

if [ -z "$STAGED_MD_FILES" ]; then
  # No markdown files staged, skip
  exit 0
fi

# Check if any staged files are in watched folders
NEEDS_REINDEX=""

for folder in $WATCHED_FOLDERS; do
  if echo "$STAGED_MD_FILES" | grep -q "^$folder/"; then
    NEEDS_REINDEX="$NEEDS_REINDEX $folder"
  fi
done

if [ -z "$NEEDS_REINDEX" ]; then
  # No changes in watched folders, skip
  exit 0
fi

echo "ðŸ“š Markdown changes detected in watched folders. Regenerating indexes..."

# For each watched folder with changes, find ALL directories to index (recursive)
DIRS_TO_INDEX=""

for folder in $NEEDS_REINDEX; do
  if [ -d "$folder" ]; then
    # Add the root watched folder itself
    if ! echo "$DIRS_TO_INDEX" | grep -q " $folder "; then
      DIRS_TO_INDEX="$DIRS_TO_INDEX $folder "
    fi
    
    # Add all subdirectories recursively (excluding hidden directories)
    for subdir in $(find "$folder" -type d ! -name ".*" 2>/dev/null); do
      if ! echo "$DIRS_TO_INDEX" | grep -q " $subdir "; then
        DIRS_TO_INDEX="$DIRS_TO_INDEX $subdir "
      fi
    done
  fi
done

# Run the index generator for each directory
for dir in $DIRS_TO_INDEX; do
  if [ -d "$dir" ]; then
    echo "   Indexing: $dir"
    bun scripts/generate-index.ts "$dir"
    
    # Stage the generated/updated CLAUDE.md
    if [ -f "$dir/CLAUDE.md" ]; then
      git add "$dir/CLAUDE.md"
    fi
  fi
done

echo "âœ… Index generation complete."
