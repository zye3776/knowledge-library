#!/bin/sh

# Load API key from .env.local if it exists (not committed to git)
[ -f .env.local ] && export $(grep -v '^#' .env.local | xargs)

# Pre-commit hook for auto-generating markdown indexes
# Only runs when markdown files in watched folders change

# Folders to watch for changes
WATCHED_FOLDERS="docs .claude/rules"

# Get list of staged markdown files
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.md$' || true)

if [ -z "$STAGED_MD_FILES" ]; then
  # No markdown files staged, skip
  exit 0
fi

# Check if any staged files are in watched folders
NEEDS_REINDEX=""

for folder in $WATCHED_FOLDERS; do
  if echo "$STAGED_MD_FILES" | grep -q "^$folder/"; then
    NEEDS_REINDEX="$NEEDS_REINDEX $folder"
  fi
done

if [ -z "$NEEDS_REINDEX" ]; then
  # No changes in watched folders, skip
  exit 0
fi

echo "ðŸ“š Markdown changes detected in watched folders. Regenerating indexes..."

# Find all unique parent directories that need reindexing
DIRS_TO_INDEX=""

for file in $STAGED_MD_FILES; do
  for folder in $WATCHED_FOLDERS; do
    if echo "$file" | grep -q "^$folder/"; then
      # Get the immediate parent directory of the changed file
      DIR=$(dirname "$file")
      # Add to list if not already there
      if ! echo "$DIRS_TO_INDEX" | grep -q "$DIR"; then
        DIRS_TO_INDEX="$DIRS_TO_INDEX $DIR"
      fi
    fi
  done
done

# Run the index generator for each affected directory
for dir in $DIRS_TO_INDEX; do
  if [ -d "$dir" ]; then
    echo "   Indexing: $dir"
    bun scripts/generate-index.ts "$dir"
    
    # Stage the generated/updated CLAUDE.md
    if [ -f "$dir/CLAUDE.md" ]; then
      git add "$dir/CLAUDE.md"
    fi
  fi
done

echo "âœ… Index generation complete."
